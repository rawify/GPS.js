/*
GPS.js v0.7.5 8/14/2025
https://raw.org/article/using-gps-with-node-js-and-javascript/

Copyright (c) 2025, Robert Eisele (https://raw.org/)
Licensed under the MIT license.
*/
'use strict';(function(x){function l(b,a=null){if(!b)return null;const c=new Date;if(a){var d=a.slice(4),f=a.slice(2,4)-1;a=a.slice(0,2);4===d.length?c.setUTCFullYear(+d,+f,+a):c.setUTCFullYear(Number("20"+d),+f,+a)}c.setUTCHours(+b.slice(0,2));c.setUTCMinutes(+b.slice(2,4));c.setUTCSeconds(+b.slice(4,6));f=b.indexOf(".");d=0;-1!==f&&f+1<b.length&&(b=b.slice(f+1),3<=b.length?d=+b.slice(0,3):2===b.length?d=10*+b:1===b.length&&(d=100*+b));c.setUTCMilliseconds(d);return c}function m(b,a){if(""===b)return null;
let c=1;switch(a){case "S":c=-1;case "N":a=2;break;case "W":c=-1;case "E":a=3;break;default:return null}return c*(parseFloat(b.slice(0,a))+parseFloat(b.slice(a))/60)}function e(b){return""===b?null:parseFloat(b)}function r(b){return""===b?null:1.852*parseFloat(b)}function y(b){switch(b){case 0:return"QZSS";case 1:return"GPS";case 2:return"GLONASS";case 3:return"Galileo";case 4:return"BeiDou";default:return"unknown"}}function t(b){b=b.slice(1,3);switch(b){case "GP":return"GPS";case "GQ":return"QZSS";
case "GL":return"GLONASS";case "GA":return"Galileo";case "GB":return"BeiDou";default:return b}}function z(b){if(""===b)return null;switch(parseInt(b,10)){case 0:return null;case 1:return"fix";case 2:return"dgps-fix";case 3:return"pps-fix";case 4:return"rtk";case 5:return"rtk-float";case 6:return"estimated";case 7:return"manual";case 8:return"simulated"}throw Error("INVALID GGA FIX: "+b);}function A(b){if(""===b)return null;switch(parseInt(b,10)){case 1:return null;case 2:return"2D";case 3:return"3D"}throw Error("INVALID GSA FIX: "+
b);}function u(b){switch(b){case "":return null;case "A":return"active";case "V":return"void"}throw Error("INVALID RMC/GLL STATUS: "+b);}function q(b){switch(b){case "":return null;case "A":return"autonomous";case "D":return"differential";case "E":return"estimated";case "M":return"manual input";case "S":return"simulated";case "N":return"not valid";case "P":return"precise";case "R":return"rtk";case "F":return"rtk-float"}throw Error("INVALID FAA MODE: "+b);}function v(b,a){if("M"===a||""===a)return e(b);
throw Error("Unknown unit: "+a);}function k(){if(!(this instanceof k))return new k;this.events=Object.create(null);this.state={errors:0,processed:0};this._collectSats=Object.create(null);this._collectActiveSats=Object.create(null);this._lastSeenSat=Object.create(null);this.partial=""}const n=Math.PI/180;k.mod={GGA:function(b,a){if(16!==a.length&&14!==a.length)throw Error("Invalid GGA length: "+b);return{time:l(a[1]),lat:m(a[2],a[3]),lon:m(a[4],a[5]),alt:v(a[9],a[10]),quality:z(a[6]),satellites:e(a[7]),
hdop:e(a[8]),geoidal:v(a[11],a[12]),age:void 0===a[13]?null:e(a[13]),stationID:void 0===a[14]?null:e(a[14])}},GSA:function(b,a){if(19!==a.length&&20!==a.length)throw Error("Invalid GSA length: "+b);b=[];for(var c=3;15>c;c++)""!==a[c]&&b.push(parseInt(a[c],10));c=19<a.length?e(a[18]):null;a:{var d=a[1];switch(d){case "M":d="manual";break a;case "A":d="automatic";break a;case "":d=null;break a}throw Error("INVALID GSA MODE: "+d);}return{mode:d,fix:A(a[2]),satellites:b,pdop:e(a[15]),hdop:e(a[16]),vdop:e(a[17]),
systemId:c,system:null!==c?y(c):"unknown"}},RMC:function(b,a){if(13!==a.length&&14!==a.length&&15!==a.length)throw Error("Invalid RMC length: "+b);b=l(a[1],a[9]);var c=u(a[2]),d=m(a[3],a[4]),f=m(a[5],a[6]),g=r(a[7]),h=e(a[8]),p=a[10],w=a[11];return{time:b,status:c,lat:d,lon:f,speed:g,track:h,variation:""===p||""===w?null:parseFloat(p)*("W"===w?-1:1),faa:13<a.length?q(a[12]):null,navStatus:14<a.length?a[13]:null}},VTG:function(b,a){if(10!==a.length&&11!==a.length)throw Error("Invalid VTG length: "+
b);if(""===a[2]&&""===a[8]&&""===a[6])return{track:null,trackMagnetic:null,speed:null,faa:null};if("T"!==a[2])throw Error("Invalid VTG track mode: "+b);if("K"!==a[8]||"N"!==a[6])throw Error("Invalid VTG speed tag: "+b);return{track:e(a[1]),trackMagnetic:""===a[3]?null:e(a[3]),speed:r(a[5]),faa:11===a.length?q(a[9]):null}},GSV:function(b,a){if(0===a.length%4)throw Error("Invalid GSV length: "+b);const c=[],d=b.slice(1,3);for(let f=4;f<a.length-3;f+=4){const g=e(a[f]),h=e(a[f+3]);c.push({prn:g,elevation:e(a[f+
1]),azimuth:e(a[f+2]),snr:h,status:null!==g?null!==h?"tracking":"in view":null,system:t(b),key:d+g})}return{msgNumber:e(a[2]),msgsTotal:e(a[1]),satsInView:e(a[3]),satellites:c,signalId:2===a.length%4?e(a[a.length-2]):null,system:t(b)}},GLL:function(b,a){if(9!==a.length&&8!==a.length)throw Error("Invalid GLL length: "+b);return{time:l(a[5]),status:u(a[6]),lat:m(a[1],a[2]),lon:m(a[3],a[4]),faa:9===a.length?q(a[7]):null}},ZDA:function(b,a){return{time:l(a[1],a[2]+a[3]+a[4])}},GST:function(b,a){if(10!==
a.length)throw Error("Invalid GST length: "+b);return{time:l(a[1]),rms:e(a[2]),ellipseMajor:e(a[3]),ellipseMinor:e(a[4]),ellipseOrientation:e(a[5]),latitudeError:e(a[6]),longitudeError:e(a[7]),heightError:e(a[8])}},HDT:function(b,a){if(4!==a.length)throw Error("Invalid HDT length: "+b);return{heading:parseFloat(a[1]),trueNorth:"T"===a[2]}},GRS:function(b,a){if(18!==a.length)throw Error("Invalid GRS length: "+b);b=[];for(let c=3;14>=c;c++){const d=e(a[c]);null!==d&&b.push(d)}return{time:l(a[1]),mode:e(a[2]),
res:b}},GBS:function(b,a){if(10!==a.length&&12!==a.length)throw Error("Invalid GBS length: "+b);return{time:l(a[1]),errLat:e(a[2]),errLon:e(a[3]),errAlt:e(a[4]),failedSat:e(a[5]),probFailedSat:e(a[6]),biasFailedSat:e(a[7]),stdFailedSat:e(a[8]),systemId:12===a.length?e(a[9]):null,signalId:12===a.length?e(a[10]):null}},GNS:function(b,a){if(14!==a.length&&15!==a.length)throw Error("Invalid GNS length: "+b);return{time:l(a[1]),lat:m(a[2],a[3]),lon:m(a[4],a[5]),mode:a[6],satsUsed:e(a[7]),hdop:e(a[8]),
alt:e(a[9]),sep:e(a[10]),diffAge:e(a[11]),diffStation:e(a[12]),navStatus:15===a.length?a[13]:null}}};k.Parse=function(b){if("string"!==typeof b||6>b.length||36!==b.charCodeAt(0))return!1;var a=b.indexOf("*",1);if(-1===a||a+2>=b.length)return!1;var c=[],d=b.indexOf(",",1);if(-1===d||d>a)return!1;c.push("$"+b.slice(1,d));let f=0;for(var g=1;g<a;g++)f^=b.charCodeAt(g);d+=1;for(g=d;g<a;g++)44===b.charCodeAt(g)&&(c.push(b.slice(d,g)),d=g+1);c.push(b.slice(d,a));g=b.slice(a+1).trim();a=parseInt(g.slice(0,
2),16);if(!(0<=a&&255>=a))return!1;c[0]=c[0].slice(3);d=c[0];const h=k.mod[d];if(void 0===h)return!1;c.push(g.slice(0,2));c=h(b,c);c.raw=b;c.valid=f===a;c.type=d;return c};k.Heading=function(b,a,c,d){a=(d-a)*n;b*=n;c*=n;d=Math.cos(c);return(180*Math.atan2(Math.sin(a)*d,Math.cos(b)*Math.sin(c)-Math.sin(b)*d*Math.cos(a))/Math.PI+360)%360};k.Distance=function(b,a,c,d){var f=(c-b)*n*.5;a=(d-a)*n*.5;b*=n;c*=n;f=Math.sin(f);a=Math.sin(a);return 12745.6*Math.asin(Math.sqrt(f*f+Math.cos(b)*Math.cos(c)*a*
a))};k.TotalDistance=function(b){if(2>b.length)return 0;let a=0;for(let c=0;c<b.length-1;c++){const d=b[c],f=b[c+1];a+=k.Distance(d.lat,d.lon,f.lat,f.lon)}return a};k.prototype={constructor:k,_updateState:function(b){const a=this.state;if("RMC"===b.type||"GGA"===b.type||"GLL"===b.type||"GNS"===b.type)a.time=b.time,a.lat=b.lat,a.lon=b.lon;"HDT"===b.type&&(a.heading=b.heading,a.trueNorth=b.trueNorth);"ZDA"===b.type&&(a.time=b.time);"GGA"===b.type&&(a.alt=b.alt);"RMC"===b.type&&(a.speed=b.speed,a.track=
b.track);if("GSA"===b.type){var c=b.systemId;null!=c&&(this._collectActiveSats[c]=b.satellites);c=[];var d=this._collectActiveSats;for(var f in d)if(Object.prototype.hasOwnProperty.call(d,f)){var g=d[f];for(let h=0,p=g.length;h<p;h++)c.push(g[h])}a.satsActive=c;a.fix=b.fix;a.hdop=b.hdop;a.pdop=b.pdop;a.vdop=b.vdop}if("GSV"===b.type){f=Date.now();d=b.satellites;b=this._collectSats;c=this._lastSeenSat;for(let h=0,p=d.length;h<p;h++)g=d[h].key,c[g]=f,b[g]=d[h];d=[];for(const h in b)Object.prototype.hasOwnProperty.call(b,
h)&&(3E3>f-c[h]?d.push(b[h]):(delete b[h],delete c[h]));a.satsVisible=d}},update:function(b){b=k.Parse(b);this.state.processed++;if(!1===b)return this.state.errors++,!1;this._updateState(b);this.emit("data",b);this.emit(b.type,b);return!0},updatePartial:function(b){for(b&&(this.partial+=b);;){b=this.partial.indexOf("\r\n");var a=this.partial.indexOf("\n");let c=-1;-1!==b?c=b:-1!==a&&(c=a);if(-1===c)break;a=this.partial.slice(0,c);this.partial=this.partial.slice(c+(b===c?2:1));if("$"===a.charAt(0))try{this.update(a)}catch(d){throw this.state.errors++,
d;}}},on:function(b,a){const c=this.events[b];void 0===c?this.events[b]=[a]:"function"===typeof c?this.events[b]=[c,a]:this.events[b].push(a);return this},off:function(b,a){const c=this.events[b];if(void 0===c)return this;if(!a)return delete this.events[b],this;if("function"===typeof c)return c===a&&delete this.events[b],this;for(let d=c.length-1;0<=d;d--)c[d]===a&&c.splice(d,1);0===c.length&&delete this.events[b];return this},emit:function(b,a){b=this.events[b];if(void 0!==b)if("function"===typeof b)b.call(this,
a);else for(let c=0,d=b.length;c<d;c++)b[c].call(this,a)}};"function"===typeof define&&define.amd?define([],function(){return k}):"object"===typeof exports?(Object.defineProperty(k,"__esModule",{value:!0}),k["default"]=k,k.GPS=k,module.exports=k):x.GPS=k})(this);
